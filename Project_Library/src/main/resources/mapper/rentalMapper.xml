<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fort4.mapper.RentalMapper">

	<insert id="insertRental">
	    INSERT INTO rental (book_id, username, rental_date, is_returned)
	    VALUES (#{bookId}, #{username}, NOW(), false)
	</insert>
	
	<select id="countNotReturned" resultType="int">
	    SELECT COUNT(*) FROM rental WHERE book_id = #{bookId} AND is_returned = false
	</select>
	
	<select id="getRentalByBookIdAndUsername" resultType="com.fort4.dto.RentalDTO">
	    SELECT * FROM rental
	    WHERE book_id = #{bookId}
	      AND username = #{username}
	      AND is_returned = false
	</select>
	
	<!-- 대여 연장 -->
	<update id="extendRental">
	    UPDATE rental
	    SET return_date = DATE_ADD(return_date, INTERVAL 3 DAY),
	        extend_count = extend_count + 1
	    WHERE rental_id = #{rentalId}
	</update>
	
	
	<!-- 대여횟수 TOP5 -->
	<select id="getTopRentedBooks" resultType="com.fort4.dto.BookDTO">
	    SELECT b.*, COUNT(*) AS rental_count
	    FROM books b
	    JOIN rental r ON b.book_id = r.book_id
	    GROUP BY b.book_id
	    ORDER BY COUNT(*) DESC
	    LIMIT 5
	</select>
	
	<!-- 도서 반납 -->
	<update id="returnBook">
	    UPDATE rental
	    SET is_returned = true,
	        return_date = NOW()
	    WHERE rental_id = #{rentalId}
	</update>
	
	<!-- 사용자용 대여 -->
	<select id="getMyRentals" resultType="com.fort4.dto.RentalDTO">
	    SELECT *
	    FROM rental
	    WHERE username = #{username}
	    ORDER BY rental_date DESC
	</select>
	
	<!-- 대여 통계용 -->
	<select id="countTotalRentals" resultType="int">
    	SELECT COUNT(*) FROM rental
	</select>
	

</mapper>
